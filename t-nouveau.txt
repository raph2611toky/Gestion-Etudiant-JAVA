package com.studentmanagement.ui.etudiant;

import javax.swing.*;
import javax.swing.table.*;
import javax.swing.border.AbstractBorder;
import java.awt.*;
import java.awt.event.*;
import java.awt.geom.*;
import java.io.File;
import java.io.InputStream;
import java.net.URI;
import java.net.URL;
import java.util.List;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.regex.Pattern;
import com.studentmanagement.model.Etudiant;
import com.studentmanagement.model.Niveau;
import com.studentmanagement.model.Parcours;
import com.studentmanagement.model.Matiere;
import com.studentmanagement.model.Note;
import com.studentmanagement.service.ApiException;
import com.studentmanagement.service.StudentService;
import com.studentmanagement.ui.common.MainWindow;
import com.studentmanagement.ui.common.SidebarUtil;
// import com.studentmanagement.ui.common.ModernComponents;

public class StudentManagementFrame extends JPanel {
    private static final long serialVersionUID = 1L;
    private JTextField matriculeField, firstNameField, lastNameField, emailField, adresseField, niveauClasseField;
    private JComboBox<Niveau> niveauComboBox;
    private JComboBox<Parcours> parcoursComboBox;
    private JComboBox<String> niveauFilterComboBox;
    private JComboBox<String> parcoursFilterComboBox;
    private DefaultTableModel tableModel;
    private JTable studentTable;
    private JPanel cardsPanel;
    private MainWindow mainWindow;
    private StudentService studentService;
    private boolean isTableView = true;
    private JDialog studentDialog;
    private String responsableId;
    private File selectedPhoto;
    private JLabel photoPreviewLabel;
    private JTextField searchField;
    private List<Etudiant> allStudents = new ArrayList<>();
    private List<Niveau> allNiveaux = new ArrayList<>();
    private List<Parcours> allParcours = new ArrayList<>();

    // Modern Color Palette
    private static final Color PRIMARY_COLOR = new Color(99, 102, 241);
    private static final Color SECONDARY_COLOR = new Color(139, 92, 246);
    private static final Color SUCCESS_COLOR = new Color(34, 197, 94);
    private static final Color WARNING_COLOR = new Color(251, 146, 60);
    private static final Color ERROR_COLOR = new Color(239, 68, 68);
    private static final Color BACKGROUND_COLOR = new Color(248, 250, 252);
    private static final Color CARD_COLOR = Color.WHITE;
    private static final Color TEXT_PRIMARY = new Color(15, 23, 42);
    private static final Color TEXT_SECONDARY = new Color(100, 116, 139);
    private static final Color BORDER_COLOR = new Color(226, 232, 240);
    private static final Color HOVER_COLOR = new Color(241, 245, 249);
    private static final Color NOTES_COLOR = new Color(59, 130, 246);

    public StudentManagementFrame(MainWindow mainWindow) {
        this.mainWindow = mainWindow;
        this.studentService = new StudentService();
        this.responsableId = mainWindow.getCurrentResponsable() != null ? mainWindow.getCurrentResponsable().getId() : null;
        if (this.responsableId != null) {
            this.studentService.setJwtToken(mainWindow.getCurrentResponsable().getToken());
        } else {
            showErrorNotification("Erreur: Responsable non identifi√©.");
        }

        // Register Noto Emoji font
        try {
            InputStream fontStream = getClass().getResourceAsStream("/fonts/NotoEmoji-Regular.ttf");
            if (fontStream != null) {
                Font notoEmoji = Font.createFont(Font.TRUETYPE_FONT, fontStream);
                GraphicsEnvironment ge = GraphicsEnvironment.getLocalGraphicsEnvironment();
                ge.registerFont(notoEmoji);
                fontStream.close();
            } else {
                System.err.println("Font file NotoEmoji-Regular.ttf not found in resources.");
            }
        } catch (Exception e) {
            System.err.println("Erreur lors du chargement de la police Noto Emoji: " + e.getMessage());
        }

        initializeUI();
        loadNiveauxAndParcours();
        loadStudents();
    }

    private Font getEmojiSupportedFont(int style, int size) {
        String[] preferredFonts = {"Noto Emoji", "Segoe UI Emoji", "Noto Sans", "SansSerif"};
        for (String fontName : preferredFonts) {
            if (Arrays.stream(GraphicsEnvironment.getLocalGraphicsEnvironment().getAvailableFontFamilyNames())
                    .anyMatch(name -> name.equals(fontName))) {
                return new Font(fontName, style, size);
            }
        }
        return new Font("SansSerif", style, size);
    }

    private void initializeUI() {
        setLayout(new BorderLayout());
        setBackground(BACKGROUND_COLOR);

        JPanel sidebar = SidebarUtil.createSidebar(mainWindow, "Students");
        add(sidebar, BorderLayout.WEST);

        JPanel mainContent = createMainContent();
        add(mainContent, BorderLayout.CENTER);
    }

    private void loadNiveauxAndParcours() {
        try {
            List<Niveau> niveaux = studentService.getAllNiveaux();
            allNiveaux = niveaux != null ? new ArrayList<>(niveaux) : new ArrayList<>();
            if (allNiveaux.isEmpty()) {
                showWarningNotification("Aucun niveau trouv√©. Veuillez ajouter des niveaux dans Param√®tres.");
            }
        } catch (ApiException ex) {
            showErrorNotification("Erreur lors du chargement des niveaux: " + ex.getMessage());
            allNiveaux = new ArrayList<>();
        }

        try {
            List<Parcours> parcours = studentService.getAllParcours();
            allParcours = parcours != null ? new ArrayList<>(parcours) : new ArrayList<>();
            if (allParcours.isEmpty()) {
                showWarningNotification("Aucun parcours trouv√©. Veuillez ajouter des parcours dans Param√®tres.");
            }
        } catch (ApiException ex) {
            showErrorNotification("Erreur lors du chargement des parcours: " + ex.getMessage());
            allParcours = new ArrayList<>();
        }
    }

    private JPanel createMainContent() {
        JPanel mainContent = new JPanel(new BorderLayout());
        mainContent.setBackground(BACKGROUND_COLOR);
        mainContent.setBorder(BorderFactory.createEmptyBorder(30, 30, 30, 30));

        JPanel headerSection = createEnhancedHeader();
        mainContent.add(headerSection, BorderLayout.NORTH);

        JPanel contentPanel = createContentPanel();
        mainContent.add(contentPanel, BorderLayout.CENTER);
        return mainContent;
    }

    private JPanel createEnhancedHeader() {
        JPanel headerSection = new JPanel(new BorderLayout());
        headerSection.setBackground(BACKGROUND_COLOR);
        headerSection.setBorder(BorderFactory.createEmptyBorder(0, 0, 30, 0));

        JPanel titleSection = new JPanel();
        titleSection.setLayout(new BoxLayout(titleSection, BoxLayout.Y_AXIS));
        titleSection.setBackground(BACKGROUND_COLOR);

        JLabel titleLabel = new JLabel("üéì Gestion des √âtudiants");
        titleLabel.setFont(getEmojiSupportedFont(Font.BOLD, 32));
        titleLabel.setForeground(TEXT_PRIMARY);

        JLabel breadcrumbLabel = new JLabel("Dashboard > Gestion des √âtudiants");
        breadcrumbLabel.setFont(getEmojiSupportedFont(Font.PLAIN, 14));
        breadcrumbLabel.setForeground(TEXT_SECONDARY);

        titleSection.add(titleLabel);
        titleSection.add(Box.createVerticalStrut(5));
        titleSection.add(breadcrumbLabel);

        JPanel controlsSection = createControlsSection();
        headerSection.add(titleSection, BorderLayout.WEST);
        headerSection.add(controlsSection, BorderLayout.EAST);

        return headerSection;
    }

    private JPanel createControlsSection() {
        JPanel controlsSection = new JPanel();
        controlsSection.setLayout(new BoxLayout(controlsSection, BoxLayout.Y_AXIS));
        controlsSection.setBackground(BACKGROUND_COLOR);

        JPanel filtersPanel = createFiltersPanel();
        controlsSection.add(filtersPanel);
        controlsSection.add(Box.createVerticalStrut(15));

        JPanel buttonsPanel = createActionButtonsPanel();
        controlsSection.add(buttonsPanel);

        return controlsSection;
    }

    private JPanel createFiltersPanel() {
        JPanel filtersPanel = new JPanel(new FlowLayout(FlowLayout.RIGHT, 15, 0));
        filtersPanel.setBackground(BACKGROUND_COLOR);

        searchField = createEnhancedSearchField();
        filtersPanel.add(searchField);

        niveauFilterComboBox = createEnhancedComboBox("TOUS LES NIVEAUX");
        if (allNiveaux != null) {
            for (Niveau niveau : new ArrayList<>(allNiveaux)) {
                if (niveau != null && niveau.getNom() != null) {
                    niveauFilterComboBox.addItem(niveau.getNom());
                }
            }
        }
        niveauFilterComboBox.addActionListener(_ -> filterStudents());
        filtersPanel.add(niveauFilterComboBox);

        parcoursFilterComboBox = createEnhancedComboBox("TOUS LES PARCOURS");
        if (allParcours != null) {
            for (Parcours parcours : new ArrayList<>(allParcours)) {
                if (parcours != null && parcours.getNom() != null) {
                    parcoursFilterComboBox.addItem(parcours.getNom());
                }
            }
        }
        parcoursFilterComboBox.addActionListener(_ -> filterStudents());
        filtersPanel.add(parcoursFilterComboBox);

        return filtersPanel;
    }

    private JTextField createEnhancedSearchField() {
        JTextField searchField = new JTextField("üîç Rechercher des √©tudiants...") {
            @Override
            protected void paintComponent(Graphics g) {
                Graphics2D g2d = (Graphics2D) g.create();
                g2d.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);
                g2d.setColor(getBackground());
                g2d.fillRoundRect(0, 0, getWidth(), getHeight(), 12, 12);
                g2d.dispose();
                super.paintComponent(g);
            }
        };

        searchField.setFont(getEmojiSupportedFont(Font.PLAIN, 14));
        searchField.setPreferredSize(new Dimension(280, 42));
        searchField.setBackground(CARD_COLOR);
        searchField.setForeground(TEXT_SECONDARY);
        searchField.setBorder(BorderFactory.createCompoundBorder(
                new ModernBorder(BORDER_COLOR),
                BorderFactory.createEmptyBorder(12, 16, 12, 16)));

        searchField.addFocusListener(new FocusAdapter() {
            @Override
            public void focusGained(FocusEvent e) {
                if (searchField.getText().equals("üîç Rechercher des √©tudiants...")) {
                    searchField.setText("");
                    searchField.setForeground(TEXT_PRIMARY);
                }
                searchField.setBorder(BorderFactory.createCompoundBorder(
                        new ModernBorder(PRIMARY_COLOR),
                        BorderFactory.createEmptyBorder(12, 16, 12, 16)));
            }

            @Override
            public void focusLost(FocusEvent e) {
                if (searchField.getText().isEmpty()) {
                    searchField.setText("üîç Rechercher des √©tudiants...");
                    searchField.setForeground(TEXT_SECONDARY);
                }
                searchField.setBorder(BorderFactory.createCompoundBorder(
                        new ModernBorder(BORDER_COLOR),
                        BorderFactory.createEmptyBorder(12, 16, 12, 16)));
            }
        });

        searchField.getDocument().addDocumentListener(new javax.swing.event.DocumentListener() {
            public void insertUpdate(javax.swing.event.DocumentEvent e) {
                filterStudents();
            }

            public void removeUpdate(javax.swing.event.DocumentEvent e) {
                filterStudents();
            }

            public void changedUpdate(javax.swing.event.DocumentEvent e) {
                filterStudents();
            }
        });

        return searchField;
    }

    private JComboBox<String> createEnhancedComboBox(String defaultItem) {
        JComboBox<String> comboBox = new JComboBox<String>() {
            @Override
            protected void paintComponent(Graphics g) {
                Graphics2D g2d = (Graphics2D) g.create();
                g2d.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);
                g2d.setColor(getBackground());
                g2d.fillRoundRect(0, 0, getWidth(), getHeight(), 12, 12);
                g2d.dispose();
                super.paintComponent(g);
            }
        };

        comboBox.addItem(defaultItem);
        comboBox.setFont(getEmojiSupportedFont(Font.PLAIN, 14));
        comboBox.setPreferredSize(new Dimension(180, 42));
        comboBox.setBackground(CARD_COLOR);
        comboBox.setForeground(TEXT_PRIMARY);
        comboBox.setBorder(BorderFactory.createCompoundBorder(
                new ModernBorder(BORDER_COLOR),
                BorderFactory.createEmptyBorder(8, 12, 8, 12)));

        return comboBox;
    }

    private JPanel createActionButtonsPanel() {
        JPanel buttonsPanel = new JPanel(new FlowLayout(FlowLayout.RIGHT, 15, 0));
        buttonsPanel.setBackground(BACKGROUND_COLOR);

        JButton viewToggleButton = createEnhancedButton(
                isTableView ? "üìã Vue Cartes" : "üìä Vue Tableau",
                SECONDARY_COLOR,
                false);
        viewToggleButton.addActionListener(_ -> toggleView(viewToggleButton));

        JButton addButton = createEnhancedButton("‚ûï Ajouter √âtudiant", PRIMARY_COLOR, true);
        addButton.addActionListener(_ -> showStudentFormDialog(null));

        buttonsPanel.add(viewToggleButton);
        buttonsPanel.add(addButton);

        return buttonsPanel;
    }

    private JButton createEnhancedButton(String text, Color bgColor, boolean isPrimary) {
        JButton button = new JButton(text) {
            @Override
            protected void paintComponent(Graphics g) {
                Graphics2D g2d = (Graphics2D) g.create();
                g2d.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);

                Color currentColor;
                if (getModel().isPressed()) {
                    currentColor = bgColor.darker();
                } else if (getModel().isRollover()) {
                    currentColor = isPrimary ? bgColor.brighter() : HOVER_COLOR;
                } else {
                    currentColor = isPrimary ? bgColor : CARD_COLOR;
                }

                g2d.setColor(currentColor);
                g2d.fillRoundRect(0, 0, getWidth(), getHeight(), 12, 12);

                if (!isPrimary) {
                    g2d.setColor(BORDER_COLOR);
                    g2d.setStroke(new BasicStroke(1));
                    g2d.drawRoundRect(0, 0, getWidth() - 1, getHeight() - 1, 12, 12);
                }

                g2d.dispose();
                super.paintComponent(g);
            }
        };

        button.setFont(getEmojiSupportedFont(Font.BOLD, 14));
        button.setForeground(isPrimary ? Color.WHITE : TEXT_PRIMARY);
        button.setContentAreaFilled(false);
        button.setBorderPainted(false);
        button.setFocusPainted(false);
        button.setCursor(new Cursor(Cursor.HAND_CURSOR));
        button.setBorder(BorderFactory.createEmptyBorder(12, 24, 12, 24));

        return button;
    }

    private JPanel createContentPanel() {
        JPanel contentPanel = new JPanel(new CardLayout());
        contentPanel.setBackground(BACKGROUND_COLOR);

        JPanel tablePanel = createEnhancedTableView();
        contentPanel.add(tablePanel, "table");

        cardsPanel = createEnhancedCardsView();
        JScrollPane cardsScrollPane = createEnhancedScrollPane(cardsPanel);
        contentPanel.add(cardsScrollPane, "cards");

        return contentPanel;
    }

    private JPanel createEnhancedTableView() {
        JPanel panel = new JPanel(new BorderLayout());
        panel.setBackground(BACKGROUND_COLOR);

        String[] columns = { "Matricule", "Pr√©nom", "Nom", "Email", "Adresse", "Niveau", "Parcours", "Photo", "Actions" };
        tableModel = new DefaultTableModel(columns, 0) {
            @Override
            public boolean isCellEditable(int row, int column) {
                return column == 8;
            }
        };

        studentTable = createEnhancedTable();

        studentTable.getColumn("Photo").setCellRenderer(new EnhancedPhotoCellRenderer());
        studentTable.getColumn("Photo").setPreferredWidth(70);
        studentTable.getColumn("Photo").setMaxWidth(70);
        studentTable.getColumn("Photo").setMinWidth(70);

        studentTable.getColumn("Actions").setCellRenderer(new EnhancedButtonRenderer());
        studentTable.getColumn("Actions").setCellEditor(new EnhancedButtonEditor());
        studentTable.getColumn("Actions").setPreferredWidth(200);

        JScrollPane scrollPane = createEnhancedScrollPane(studentTable);
        panel.add(scrollPane, BorderLayout.CENTER);

        return panel;
    }

    private JTable createEnhancedTable() {
        JTable table = new JTable(tableModel) {
            @Override
            public Component prepareRenderer(TableCellRenderer renderer, int row, int column) {
                Component comp = super.prepareRenderer(renderer, row, column);

                if (!isRowSelected(row)) {
                    comp.setBackground(row % 2 == 0 ? CARD_COLOR : new Color(249, 250, 251));
                } else {
                    comp.setBackground(new Color(239, 246, 255));
                }

                if (comp instanceof JLabel) {
                    ((JLabel) comp).setHorizontalAlignment(JLabel.CENTER);
                }

                return comp;
            }
        };

        table.setFont(getEmojiSupportedFont(Font.PLAIN, 14));
        table.setRowHeight(60);
        table.setBackground(CARD_COLOR);
        table.setSelectionBackground(new Color(239, 246, 255));
        table.setSelectionForeground(TEXT_PRIMARY);
        table.setGridColor(new Color(241, 245, 249));
        table.setShowVerticalLines(false);
        table.setIntercellSpacing(new Dimension(0, 1));

        JTableHeader header = table.getTableHeader();
        header.setFont(getEmojiSupportedFont(Font.BOLD, 14));
        header.setBackground(new Color(248, 250, 252));
        header.setForeground(TEXT_PRIMARY);
        header.setBorder(BorderFactory.createMatteBorder(0, 0, 2, 0, BORDER_COLOR));
        header.setPreferredSize(new Dimension(header.getPreferredSize().width, 50));
        ((DefaultTableCellRenderer) header.getDefaultRenderer()).setHorizontalAlignment(JLabel.CENTER);

        return table;
    }

    private JScrollPane createEnhancedScrollPane(Component component) {
        JScrollPane scrollPane = new JScrollPane(component) {
            @Override
            protected void paintComponent(Graphics g) {
                Graphics2D g2d = (Graphics2D) g.create();
                g2d.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);

                g2d.setColor(new Color(0, 0, 0, 10));
                g2d.fillRoundRect(3, 3, getWidth() - 6, getHeight() - 6, 16, 16);

                g2d.setColor(CARD_COLOR);
                g2d.fillRoundRect(0, 0, getWidth() - 3, getHeight() - 3, 16, 16);

                g2d.dispose();
                super.paintComponent(g);
            }
        };

        scrollPane.setBorder(BorderFactory.createEmptyBorder());
        scrollPane.getViewport().setBackground(CARD_COLOR);
        scrollPane.setBackground(BACKGROUND_COLOR);
        scrollPane.getVerticalScrollBar().setUnitIncrement(16);

        return scrollPane;
    }

    private JPanel createEnhancedCardsView() {
        JPanel panel = new JPanel();
        panel.setLayout(new GridLayout(0, 3, 25, 25));
        panel.setBackground(BACKGROUND_COLOR);
        panel.setBorder(BorderFactory.createEmptyBorder(25, 25, 25, 25));
        return panel;
    }

    private void toggleView(JButton toggleButton) {
        isTableView = !isTableView;
        toggleButton.setText(isTableView ? "üìã Vue Cartes" : "üìä Vue Tableau");

        CardLayout cl = (CardLayout) ((JPanel) ((JPanel) getComponent(1)).getComponent(1)).getLayout();
        cl.show((JPanel) ((JPanel) getComponent(1)).getComponent(1), isTableView ? "table" : "cards");

        if (!isTableView) {
            updateCardsView();
        }
    }

    private void updateCardsView() {
        if (cardsPanel != null) {
            cardsPanel.removeAll();
            List<Etudiant> students = filterStudentsList();
            for (Etudiant etudiant : students) {
                if (etudiant != null) {
                    JPanel card = createEnhancedStudentCard(etudiant);
                    cardsPanel.add(card);
                }
            }
            cardsPanel.revalidate();
            cardsPanel.repaint();
        }
    }

    private JPanel createEnhancedStudentCard(Etudiant etudiant) {
        JPanel card = new JPanel() {
            @Override
            protected void paintComponent(Graphics g) {
                Graphics2D g2d = (Graphics2D) g.create();
                g2d.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);

                g2d.setColor(new Color(0, 0, 0, 15));
                g2d.fillRoundRect(4, 4, getWidth() - 8, getHeight() - 8, 20, 20);

                GradientPaint gradient = new GradientPaint(0, 0, CARD_COLOR, 0, getHeight(), new Color(253, 254, 255));
                g2d.setPaint(gradient);
                g2d.fillRoundRect(0, 0, getWidth() - 4, getHeight() - 4, 20, 20);

                g2d.setColor(BORDER_COLOR);
                g2d.setStroke(new BasicStroke(1));
                g2d.drawRoundRect(0, 0, getWidth() - 4, getHeight() - 4, 20, 20);

                g2d.dispose();
            }
        };

        card.setLayout(new BorderLayout(20, 20));
        card.setBorder(BorderFactory.createEmptyBorder(30, 30, 30, 30));
        card.setPreferredSize(new Dimension(350, 320));

        JPanel photoSection = createEnhancedCardPhotoSection(etudiant);
        card.add(photoSection, BorderLayout.NORTH);

        JPanel infoSection = createEnhancedCardInfoSection(etudiant);
        card.add(infoSection, BorderLayout.CENTER);

        JPanel actionsSection = createEnhancedCardActionsSection(etudiant);
        card.add(actionsSection, BorderLayout.SOUTH);

        return card;
    }

    private JPanel createEnhancedCardPhotoSection(Etudiant etudiant) {
        JPanel photoSection = new JPanel(new FlowLayout(FlowLayout.CENTER));
        photoSection.setBackground(Color.WHITE);

        EnhancedRoundImageLabel photoLabel = new EnhancedRoundImageLabel(70);
        if (etudiant != null && etudiant.getphoto_url() != null && !etudiant.getphoto_url().isEmpty()) {
            try {
                photoLabel.setImage(URI.create(etudiant.getphoto_url()).toURL());
            } catch (Exception e) {
                photoLabel.setText("üë§");
            }
        } else {
            photoLabel.setText("üë§");
        }

        photoSection.add(photoLabel);
        return photoSection;
    }

    private JPanel createEnhancedCardInfoSection(Etudiant etudiant) {
        JPanel infoSection = new JPanel();
        infoSection.setLayout(new BoxLayout(infoSection, BoxLayout.Y_AXIS));
        infoSection.setBackground(Color.WHITE);

        String name = etudiant != null ? (etudiant.getPrenom() != null ? etudiant.getPrenom() : "") + " " +
                (etudiant.getNom() != null ? etudiant.getNom() : "") : "N/A";
        JLabel nameLabel = new JLabel(name);
        nameLabel.setFont(getEmojiSupportedFont(Font.BOLD, 20));
        nameLabel.setForeground(TEXT_PRIMARY);
        nameLabel.setAlignmentX(Component.CENTER_ALIGNMENT);

        String matricule = etudiant != null && etudiant.getMatricule() != null ? etudiant.getMatricule() : "N/A";
        JLabel matriculeLabel = new JLabel("üìã " + matricule);
        matriculeLabel.setFont(getEmojiSupportedFont(Font.BOLD, 14));
        matriculeLabel.setForeground(PRIMARY_COLOR);
        matriculeLabel.setAlignmentX(Component.CENTER_ALIGNMENT);

        String email = etudiant != null && etudiant.getEmail() != null ? etudiant.getEmail() : "N/A";
        JLabel emailLabel = new JLabel("üìß " + email);
        emailLabel.setFont(getEmojiSupportedFont(Font.PLAIN, 13));
        emailLabel.setForeground(TEXT_SECONDARY);
        emailLabel.setAlignmentX(Component.CENTER_ALIGNMENT);

        String niveau = etudiant != null ? getNiveauLabel(etudiant.getNiveauId()) : "N/A";
        JLabel niveauLabel = new JLabel("üìö " + niveau);
        niveauLabel.setFont(getEmojiSupportedFont(Font.PLAIN, 13));
        niveauLabel.setForeground(TEXT_SECONDARY);
        niveauLabel.setAlignmentX(Component.CENTER_ALIGNMENT);

        String parcours = etudiant != null ? getParcoursLabel(etudiant.getParcoursId()) : "N/A";
        JLabel parcoursLabel = new JLabel("üéØ " + parcours);
        parcoursLabel.setFont(getEmojiSupportedFont(Font.PLAIN, 13));
        parcoursLabel.setForeground(TEXT_SECONDARY);
        parcoursLabel.setAlignmentX(Component.CENTER_ALIGNMENT);

        infoSection.add(nameLabel);
        infoSection.add(Box.createVerticalStrut(10));
        infoSection.add(matriculeLabel);
        infoSection.add(Box.createVerticalStrut(8));
        infoSection.add(emailLabel);
        infoSection.add(Box.createVerticalStrut(6));
        infoSection.add(niveauLabel);
        infoSection.add(Box.createVerticalStrut(6));
        infoSection.add(parcoursLabel);

        return infoSection;
    }

    private JPanel createEnhancedCardActionsSection(Etudiant etudiant) {
        JPanel actionsSection = new JPanel(new FlowLayout(FlowLayout.CENTER, 12, 0));
        actionsSection.setBackground(Color.WHITE);

        JButton editButton = createEnhancedCardActionButton("‚úèÔ∏è", WARNING_COLOR, "Modifier");
        editButton.addActionListener(_ -> showStudentFormDialog(etudiant));

        JButton deleteButton = createEnhancedCardActionButton("üóëÔ∏è", ERROR_COLOR, "Supprimer");
        deleteButton.addActionListener(_ -> {
            if (etudiant != null && etudiant.getId() != null) {
                deleteStudent(etudiant.getId());
            }
        });

        JButton updateButton = createEnhancedCardActionButton("üîÑ", SECONDARY_COLOR, "Niveau/Parcours");
        updateButton.addActionListener(_ -> showUpdateNiveauParcoursDialog(etudiant));

        JButton notesButton = createEnhancedCardActionButton("üìù", NOTES_COLOR, "G√©rer les Notes");
        notesButton.addActionListener(_ -> showNotesDialog(etudiant));

        actionsSection.add(editButton);
        actionsSection.add(deleteButton);
        actionsSection.add(updateButton);
        actionsSection.add(notesButton);

        return actionsSection;
    }

    private JButton createEnhancedCardActionButton(String icon, Color color, String tooltip) {
        JButton button = new JButton(icon) {
            @Override
            protected void paintComponent(Graphics g) {
                Graphics2D g2d = (Graphics2D) g.create();
                g2d.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);

                Color currentColor;
                if (getModel().isPressed()) {
                    currentColor = color.darker();
                } else if (getModel().isRollover()) {
                    currentColor = color.brighter();
                } else {
                    currentColor = color;
                }

                g2d.setColor(currentColor);
                g2d.fillOval(0, 0, getWidth(), getHeight());

                g2d.setColor(new Color(0, 0, 0, 20));
                g2d.setStroke(new BasicStroke(1));
                g2d.drawOval(1, 1, getWidth() - 3, getHeight() - 3);

                g2d.dispose();
                super.paintComponent(g);
            }
        };

        button.setFont(getEmojiSupportedFont(Font.PLAIN, 16));
        button.setForeground(Color.WHITE);
        button.setContentAreaFilled(false);
        button.setBorderPainted(false);
        button.setFocusPainted(false);
        button.setCursor(new Cursor(Cursor.HAND_CURSOR));
        button.setPreferredSize(new Dimension(40, 40));
        button.setToolTipText(tooltip);

        return button;
    }

    private void showStudentFormDialog(Etudiant etudiant) {
        boolean isEdit = etudiant != null;
        studentDialog = new JDialog((Frame) SwingUtilities.getWindowAncestor(this),
                isEdit ? "Modifier l'√âtudiant" : "Ajouter un √âtudiant", true);
        studentDialog.setLayout(new BorderLayout());
        studentDialog.setSize(650, 850);
        studentDialog.setLocationRelativeTo(this);

        loadNiveauxAndParcours();

        JPanel mainPanel = createEnhancedDialogPanel();

        JPanel headerPanel = createEnhancedDialogHeader(
                isEdit ? "‚úèÔ∏è Modifier l'√âtudiant" : "‚ûï Ajouter un √âtudiant",
                "Veuillez remplir tous les champs requis");
        mainPanel.add(headerPanel, BorderLayout.NORTH);

        JPanel formPanel = createEnhancedStudentFormPanel(etudiant, isEdit);
        JScrollPane formScrollPane = new JScrollPane(formPanel);
        formScrollPane.setBorder(null);
        formScrollPane.getVerticalScrollBar().setUnitIncrement(16);
        mainPanel.add(formScrollPane, BorderLayout.CENTER);

        JPanel buttonPanel = createEnhancedStudentFormButtons(etudiant, isEdit);
        mainPanel.add(buttonPanel, BorderLayout.SOUTH);

        studentDialog.add(mainPanel);
        studentDialog.setVisible(true);
    }

    private JPanel createEnhancedDialogPanel() {
        JPanel panel = new JPanel(new BorderLayout());
        panel.setBackground(BACKGROUND_COLOR);
        panel.setBorder(BorderFactory.createEmptyBorder(20, 20, 20, 20));
        return panel;
    }

    private JPanel createEnhancedDialogHeader(String titleText, String subtitleText) {
        JPanel headerPanel = new JPanel();
        headerPanel.setLayout(new BoxLayout(headerPanel, BoxLayout.Y_AXIS));
        headerPanel.setBackground(CARD_COLOR);
        headerPanel.setBorder(BorderFactory.createEmptyBorder(20, 20, 20, 20));

        JLabel titleLabel = new JLabel(titleText);
        titleLabel.setFont(getEmojiSupportedFont(Font.BOLD, 24));
        titleLabel.setForeground(TEXT_PRIMARY);

        JLabel subtitleLabel = new JLabel(subtitleText);
        subtitleLabel.setFont(getEmojiSupportedFont(Font.PLAIN, 14));
        subtitleLabel.setForeground(TEXT_SECONDARY);

        headerPanel.add(titleLabel);
        headerPanel.add(Box.createVerticalStrut(10));
        headerPanel.add(subtitleLabel);

        return headerPanel;
    }

    private JPanel createEnhancedStudentFormPanel(Etudiant etudiant, boolean isEdit) {
        JPanel formPanel = new JPanel(new GridBagLayout());
        formPanel.setBackground(CARD_COLOR);
        formPanel.setBorder(BorderFactory.createEmptyBorder(20, 0, 20, 0));

        GridBagConstraints gbc = new GridBagConstraints();
        gbc.insets = new Insets(15, 0, 15, 0);
        gbc.fill = GridBagConstraints.HORIZONTAL;
        gbc.anchor = GridBagConstraints.WEST;

        gbc.gridx = 0;
        gbc.gridy = 0;
        formPanel.add(createEnhancedFormLabel("Matricule *"), gbc);
        gbc.gridy = 1;
        matriculeField = createEnhancedTextField(isEdit && etudiant != null ? etudiant.getMatricule() : "");
        matriculeField.setPreferredSize(new Dimension(550, 50));
        formPanel.add(matriculeField, gbc);

        gbc.gridy = 2;
        formPanel.add(createEnhancedFormLabel("Pr√©nom *"), gbc);
        gbc.gridy = 3;
        firstNameField = createEnhancedTextField(isEdit && etudiant != null ? etudiant.getPrenom() : "");
        firstNameField.setPreferredSize(new Dimension(550, 50));
        formPanel.add(firstNameField, gbc);

        gbc.gridy = 4;
        formPanel.add(createEnhancedFormLabel("Nom *"), gbc);
        gbc.gridy = 5;
        lastNameField = createEnhancedTextField(isEdit && etudiant != null ? etudiant.getNom() : "");
        lastNameField.setPreferredSize(new Dimension(550, 50));
        formPanel.add(lastNameField, gbc);

        gbc.gridy = 6;
        formPanel.add(createEnhancedFormLabel("Email *"), gbc);
        gbc.gridy = 7;
        emailField = createEnhancedTextField(isEdit && etudiant != null ? etudiant.getEmail() : "");
        emailField.setPreferredSize(new Dimension(550, 50));
        emailField.addKeyListener(new java.awt.event.KeyAdapter() {
            @Override
            public void keyReleased(java.awt.event.KeyEvent e) {
                validateEmailField(emailField);
            }
        });
        formPanel.add(emailField, gbc);

        gbc.gridy = 8;
        formPanel.add(createEnhancedFormLabel("Adresse"), gbc);
        gbc.gridy = 9;
        adresseField = createEnhancedTextField(isEdit && etudiant != null ? etudiant.getAdresse() : "");
        adresseField.setPreferredSize(new Dimension(550, 50));
        formPanel.add(adresseField, gbc);

        gbc.gridy = 10;
        formPanel.add(createEnhancedFormLabel("Niveau Classe"), gbc);
        gbc.gridy = 11;
        niveauClasseField = createEnhancedTextField(isEdit && etudiant != null ? etudiant.getNiveauClasse() : "");
        niveauClasseField.setPreferredSize(new Dimension(550, 50));
        formPanel.add(niveauClasseField, gbc);

        gbc.gridy = 12;
        formPanel.add(createEnhancedFormLabel("Niveau *"), gbc);
        gbc.gridy = 13;
        niveauComboBox = createEnhancedNiveauComboBox();
        niveauComboBox.setPreferredSize(new Dimension(550, 50));
        if (allNiveaux != null) {
            for (Niveau niveau : new ArrayList<>(allNiveaux)) {
                if (niveau != null) {
                    niveauComboBox.addItem(niveau);
                }
            }
        }
        if (isEdit && etudiant != null && etudiant.getNiveauId() != null && allNiveaux != null) {
            for (Niveau niveau : new ArrayList<>(allNiveaux)) {
                if (niveau != null && niveau.getId() != null && niveau.getId().equals(etudiant.getNiveauId())) {
                    niveauComboBox.setSelectedItem(niveau);
                    break;
                }
            }
        }
        formPanel.add(niveauComboBox, gbc);

        gbc.gridy = 14;
        formPanel.add(createEnhancedFormLabel("Parcours *"), gbc);
        gbc.gridy = 15;
        parcoursComboBox = createEnhancedParcoursComboBox();
        parcoursComboBox.setPreferredSize(new Dimension(550, 50));
        if (allParcours != null) {
            for (Parcours parcours : new ArrayList<>(allParcours)) {
                if (parcours != null) {
                    parcoursComboBox.addItem(parcours);
                }
            }
        }
        if (isEdit && etudiant != null && etudiant.getParcoursId() != null && allParcours != null) {
            for (Parcours parcours : new ArrayList<>(allParcours)) {
                if (parcours != null && parcours.getId() != null && parcours.getId().equals(etudiant.getParcoursId())) {
                    parcoursComboBox.setSelectedItem(parcours);
                    break;
                }
            }
        }
        formPanel.add(parcoursComboBox, gbc);

        gbc.gridy = 16;
        formPanel.add(createEnhancedFormLabel("Photo"), gbc);
        gbc.gridy = 17;
        JPanel photoPanel = createEnhancedPhotoSelectionPanel();
        formPanel.add(photoPanel, gbc);

        return formPanel;
    }

    private JLabel createEnhancedFormLabel(String text) {
        JLabel label = new JLabel(text);
        label.setFont(getEmojiSupportedFont(Font.BOLD, 14));
        label.setForeground(TEXT_PRIMARY);
        return label;
    }

    private JTextField createEnhancedTextField(String text) {
        JTextField textField = new JTextField(text) {
            @Override
            protected void paintComponent(Graphics g) {
                Graphics2D g2d = (Graphics2D) g.create();
                g2d.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);
                g2d.setColor(getBackground());
                g2d.fillRoundRect(0, 0, getWidth(), getHeight(), 12, 12);
                g2d.dispose();
                super.paintComponent(g);
            }
        };

        textField.setFont(getEmojiSupportedFont(Font.PLAIN, 14));
        textField.setBackground(CARD_COLOR);
        textField.setForeground(TEXT_PRIMARY);
        textField.setBorder(BorderFactory.createCompoundBorder(
                new ModernBorder(BORDER_COLOR),
                BorderFactory.createEmptyBorder(12, 16, 12, 16)));

        return textField;
    }

    private JComboBox<Niveau> createEnhancedNiveauComboBox() {
        JComboBox<Niveau> comboBox = new JComboBox<Niveau>() {
            @Override
            protected void paintComponent(Graphics g) {
                Graphics2D g2d = (Graphics2D) g.create();
                g2d.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);
                g2d.setColor(getBackground());
                g2d.fillRoundRect(0, 0, getWidth(), getHeight(), 12, 12);
                g2d.dispose();
                super.paintComponent(g);
            }
        };

        comboBox.setFont(getEmojiSupportedFont(Font.PLAIN, 14));
        comboBox.setBackground(CARD_COLOR);
        comboBox.setForeground(TEXT_PRIMARY);
        comboBox.setBorder(BorderFactory.createCompoundBorder(
                new ModernBorder(BORDER_COLOR),
                BorderFactory.createEmptyBorder(8, 12, 8, 12)));

        return comboBox;
    }

    private JComboBox<Parcours> createEnhancedParcoursComboBox() {
        JComboBox<Parcours> comboBox = new JComboBox<Parcours>() {
            @Override
            protected void paintComponent(Graphics g) {
                Graphics2D g2d = (Graphics2D) g.create();
                g2d.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);
                g2d.setColor(getBackground());
                g2d.fillRoundRect(0, 0, getWidth(), getHeight(), 12, 12);
                g2d.dispose();
                super.paintComponent(g);
            }
        };

        comboBox.setFont(getEmojiSupportedFont(Font.PLAIN, 14));
        comboBox.setBackground(CARD_COLOR);
        comboBox.setForeground(TEXT_PRIMARY);
        comboBox.setBorder(BorderFactory.createCompoundBorder(
                new ModernBorder(BORDER_COLOR),
                BorderFactory.createEmptyBorder(8, 12, 8, 12)));

        return comboBox;
    }

    private JPanel createEnhancedPhotoSelectionPanel() {
        JPanel photoPanel = new JPanel(new FlowLayout(FlowLayout.LEFT, 20, 0));
        photoPanel.setBackground(CARD_COLOR);

        JButton choosePhotoButton = createEnhancedButton("üì∑ Choisir une Photo", SECONDARY_COLOR, false);
        choosePhotoButton.addActionListener(_ -> {
            JFileChooser fileChooser = new JFileChooser();
            fileChooser.setFileFilter(new javax.swing.filechooser.FileNameExtensionFilter(
                    "Images (*.jpg, *.png, *.jpeg)", "jpg", "png", "jpeg"));

            if (fileChooser.showOpenDialog(studentDialog) == JFileChooser.APPROVE_OPTION) {
                selectedPhoto = fileChooser.getSelectedFile();
                if (selectedPhoto != null) {
                    photoPreviewLabel.setText("üì∑ " + selectedPhoto.getName());
                    photoPreviewLabel.setForeground(SUCCESS_COLOR);
                }
            }
        });

        photoPreviewLabel = new JLabel("Aucune photo s√©lectionn√©e");
        photoPreviewLabel.setFont(getEmojiSupportedFont(Font.ITALIC, 14));
        photoPreviewLabel.setForeground(TEXT_SECONDARY);

        photoPanel.add(choosePhotoButton);
        photoPanel.add(photoPreviewLabel);

        return photoPanel;
    }

    private JPanel createEnhancedStudentFormButtons(Etudiant etudiant, boolean isEdit) {
        JPanel buttonPanel = new JPanel(new FlowLayout(FlowLayout.CENTER, 25, 0));
        buttonPanel.setBackground(CARD_COLOR);
        buttonPanel.setBorder(BorderFactory.createEmptyBorder(30, 0, 0, 0));

        JButton saveButton = createEnhancedButton("üíæ Enregistrer", PRIMARY_COLOR, true);
        JButton cancelButton = createEnhancedButton("‚ùå Annuler", new Color(156, 163, 175), false);

        saveButton.addActionListener(_ -> saveStudent(etudiant, isEdit));
        cancelButton.addActionListener(_ -> studentDialog.dispose());

        buttonPanel.add(saveButton);
        buttonPanel.add(cancelButton);

        return buttonPanel;
    }

    private void saveStudent(Etudiant etudiant, boolean isEdit) {
        String matricule = matriculeField.getText() != null ? matriculeField.getText().trim() : "";
        String firstName = firstNameField.getText() != null ? firstNameField.getText().trim() : "";
        String lastName = lastNameField.getText() != null ? lastNameField.getText().trim() : "";
        String email = emailField.getText() != null ? emailField.getText().trim() : "";
        String adresse = adresseField.getText() != null ? adresseField.getText().trim() : "";
        String niveauClasse = niveauClasseField.getText() != null ? niveauClasseField.getText().trim() : "";
        Niveau selectedNiveau = (Niveau) niveauComboBox.getSelectedItem();
        Parcours selectedParcours = (Parcours) parcoursComboBox.getSelectedItem();

        if (matricule.isEmpty() || firstName.isEmpty() || lastName.isEmpty() || email.isEmpty()) {
            showEnhancedErrorDialog("Tous les champs marqu√©s d'un * sont obligatoires.");
            return;
        }

        if (!isValidEmail(email)) {
            showEnhancedErrorDialog("Veuillez saisir une adresse email valide.");
            emailField.requestFocus();
            return;
        }

        if (selectedNiveau == null) {
            showEnhancedErrorDialog("Veuillez s√©lectionner un niveau.");
            return;
        }

        if (selectedParcours == null) {
            showEnhancedErrorDialog("Veuillez s√©lectionner un parcours.");
            return;
        }

        Etudiant student = new Etudiant();
        student.setMatricule(matricule);
        student.setPrenom(firstName);
        student.setNom(lastName);
        student.setEmail(email);
        student.setAdresse(adresse);
        student.setNiveauClasse(niveauClasse);
        student.setNiveauId(selectedNiveau.getId());
        student.setParcoursId(selectedParcours.getId());

        try {
            if (isEdit && etudiant != null) {
                student.setId(etudiant.getId());
                studentService.updateEtudiant(etudiant.getId(), student, selectedPhoto);
                showSuccessNotification("√âtudiant modifi√© avec succ√®s!");
            } else {
                studentService.addEtudiant(student, responsableId, selectedPhoto);
                showSuccessNotification("√âtudiant ajout√© avec succ√®s!");
            }
            loadStudents();
            clearFields();
            studentDialog.dispose();
        } catch (ApiException ex) {
            showEnhancedErrorDialog("Erreur lors de l'enregistrement: " + ex.getMessage());
        }
    }

    private void showNotesDialog(Etudiant etudiant) {
        if (etudiant == null) {
            showErrorNotification("Erreur: √âtudiant non s√©lectionn√©.");
            return;
        }

        JDialog dialog = new JDialog((Frame) SwingUtilities.getWindowAncestor(this), "G√©rer les Notes", true);
        dialog.setLayout(new BorderLayout());
        dialog.setSize(600, 400);
        dialog.setLocationRelativeTo(this);

        JPanel mainPanel = createEnhancedDialogPanel();

        JPanel headerPanel = createEnhancedDialogHeader("üìù G√©rer les Notes de " + etudiant.getPrenom() + " " + etudiant.getNom(),
                "Ajoutez ou modifiez les notes de l'√©tudiant");
        mainPanel.add(headerPanel, BorderLayout.NORTH);

        JPanel notesPanel = createNotesPanel(etudiant);
        JScrollPane notesScrollPane = new JScrollPane(notesPanel);
        notesScrollPane.setBorder(null);
        mainPanel.add(notesScrollPane, BorderLayout.CENTER);

        JPanel buttonPanel = createNotesButtonPanel(dialog);
        mainPanel.add(buttonPanel, BorderLayout.SOUTH);

        dialog.add(mainPanel);
        dialog.setVisible(true);
    }

    private JPanel createNotesPanel(Etudiant etudiant) {
        JPanel notesPanel = new JPanel(new BorderLayout());
        notesPanel.setBackground(CARD_COLOR);

        DefaultTableModel notesTableModel = new DefaultTableModel(new String[]{"Mati√®re", "Note", "Semestre", "Ann√©e", "Actions"}, 0) {
            @Override
            public boolean isCellEditable(int row, int column) {
                return column == 4;
            }
        };

        JTable notesTable = new JTable(notesTableModel);
        notesTable.setRowHeight(40);
        notesTable.getColumn("Actions").setCellRenderer(new NotesButtonRenderer());
        notesTable.getColumn("Actions").setCellEditor(new NotesButtonEditor(etudiant, notesTable, notesTableModel));
        notesTable.getColumn("Actions").setPreferredWidth(100);

        try {
            List<Note> notes = studentService.getNotesByEtudiant(etudiant.getId());
            List<Matiere> matieres = studentService.getAllMatieres();
            for (Matiere matiere : matieres) {
                String noteValue = "";
                String semestre = "";
                String annee = "";
                for (Note note : notes) {
                    if (note.getMatiereId().equals(matiere.getId())) {
                        noteValue = String.valueOf(note.getValeur());
                        semestre = note.getSemestre() != null ? note.getSemestre() : "";
                        annee = note.getAnnee() != null ? note.getAnnee() : "";
                        break;
                    }
                }
                notesTableModel.addRow(new Object[]{matiere.getNom(), noteValue, semestre, annee, "Actions"});
            }
        } catch (ApiException ex) {
            showErrorNotification("Erreur lors du chargement des notes: " + ex.getMessage());
        }

        notesPanel.add(new JScrollPane(notesTable), BorderLayout.CENTER);
        return notesPanel;
    }

    private JPanel createNotesButtonPanel(JDialog dialog) {
        JPanel buttonPanel = new JPanel(new FlowLayout(FlowLayout.RIGHT));
        buttonPanel.setBackground(CARD_COLOR);
        buttonPanel.setBorder(BorderFactory.createEmptyBorder(10, 0, 10, 0));

        JButton closeButton = createEnhancedButton("Fermer", ERROR_COLOR, true);
        closeButton.addActionListener(_ -> dialog.dispose());

        buttonPanel.add(closeButton);
        return buttonPanel;
    }

    private void loadStudents() {
        try {
            allStudents = studentService.getAllEtudiants(responsableId);
            filterStudents();
        } catch (ApiException ex) {
            showErrorNotification("Erreur lors du chargement des √©tudiants: " + ex.getMessage());
            allStudents = new ArrayList<>();
        }
    }

    private void filterStudents() {
        if (tableModel != null) {
            tableModel.setRowCount(0);
            List<Etudiant> students = filterStudentsList();
            for (Etudiant e : students) {
                if (e != null) {
                    tableModel.addRow(new Object[] {
                        e.getMatricule() != null ? e.getMatricule() : "",
                        e.getPrenom() != null ? e.getPrenom() : "",
                        e.getNom() != null ? e.getNom() : "",
                        e.getEmail() != null ? e.getEmail() : "",
                        e.getAdresse() != null ? e.getAdresse() : "",
                        getNiveauLabel(e.getNiveauId()),
                        getParcoursLabel(e.getParcoursId()),
                        e.getphoto_url(),
                        "Actions",
                        e
                    });
                }
            }
            if (!isTableView) {
                updateCardsView();
            }
        }
    }

    private List<Etudiant> filterStudentsList() {
        List<Etudiant> filteredList = new ArrayList<>(allStudents);
        String searchText = searchField.getText().trim().toLowerCase();
        if (!searchText.equals("üîç Rechercher des √©tudiants...") && !searchText.isEmpty()) {
            filteredList.removeIf(e -> {
                if (e == null) return true;
                String fullName = (e.getPrenom() != null ? e.getPrenom() : "") + " " + (e.getNom() != null ? e.getNom() : "");
                String matricule = e.getMatricule() != null ? e.getMatricule() : "";
                String email = e.getEmail() != null ? e.getEmail() : "";
                return !fullName.toLowerCase().contains(searchText) &&
                       !matricule.toLowerCase().contains(searchText) &&
                       !email.toLowerCase().contains(searchText);
            });
        }

        String niveauFilter = (String) niveauFilterComboBox.getSelectedItem();
        if (!"TOUS LES NIVEAUX".equals(niveauFilter)) {
            filteredList.removeIf(e -> e == null || !getNiveauLabel(e.getNiveauId()).equals(niveauFilter));
        }

        String parcoursFilter = (String) parcoursFilterComboBox.getSelectedItem();
        if (!"TOUS LES PARCOURS".equals(parcoursFilter)) {
            filteredList.removeIf(e -> e == null || !getParcoursLabel(e.getParcoursId()).equals(parcoursFilter));
        }

        return filteredList;
    }

    private String getNiveauLabel(String niveauId) {
        if (niveauId == null || allNiveaux == null) return "N/A";
        return allNiveaux.stream()
                .filter(n -> n != null && n.getId() != null && n.getId().equals(niveauId))
                .map(Niveau::getNom)
                .findFirst()
                .orElse("N/A");
    }

    private String getParcoursLabel(String parcoursId) {
        if (parcoursId == null || allParcours == null) return "N/A";
        return allParcours.stream()
                .filter(p -> p != null && p.getId() != null && p.getId().equals(parcoursId))
                .map(Parcours::getNom)
                .findFirst()
                .orElse("N/A");
    }

    private void deleteStudent(String studentId) {
        int response = JOptionPane.showConfirmDialog(this,
                "√ätes-vous s√ªr de vouloir supprimer cet √©tudiant ?",
                "Confirmer la suppression",
                JOptionPane.YES_NO_OPTION,
                JOptionPane.WARNING_MESSAGE);
        if (response == JOptionPane.YES_OPTION) {
            try {
                studentService.deleteEtudiant(studentId);
                showSuccessNotification("√âtudiant supprim√© avec succ√®s!");
                loadStudents();
            } catch (ApiException ex) {
                showErrorNotification("Erreur lors de la suppression: " + ex.getMessage());
            }
        }
    }

    private void showUpdateNiveauParcoursDialog(Etudiant etudiant) {
        if (etudiant == null) {
            showErrorNotification("Erreur: √âtudiant non s√©lectionn√©.");
            return;
        }

        JDialog dialog = new JDialog((Frame) SwingUtilities.getWindowAncestor(this), "Mettre √† jour Niveau/Parcours", true);
        dialog.setLayout(new BorderLayout());
        dialog.setSize(500, 300);
        dialog.setLocationRelativeTo(this);

        JPanel mainPanel = createEnhancedDialogPanel();

        JPanel headerPanel = createEnhancedDialogHeader("üîÑ Mettre √† jour Niveau/Parcours",
                "S√©lectionnez le nouveau niveau et parcours pour " + etudiant.getPrenom() + " " + etudiant.getNom());
        mainPanel.add(headerPanel, BorderLayout.NORTH);

        JPanel updatePanel = new JPanel(new GridBagLayout());
        updatePanel.setBackground(CARD_COLOR);
        GridBagConstraints gbc = new GridBagConstraints();
        gbc.insets = new Insets(10, 10, 10, 10);
        gbc.fill = GridBagConstraints.HORIZONTAL;

        gbc.gridx = 0;
        gbc.gridy = 0;
        updatePanel.add(createEnhancedFormLabel("Niveau"), gbc);
        gbc.gridx = 1;
        JComboBox<Niveau> niveauUpdateCombo = createEnhancedNiveauComboBox();
        niveauUpdateCombo.setPreferredSize(new Dimension(300, 40));
        for (Niveau niveau : allNiveaux) {
            if (niveau != null) {
                niveauUpdateCombo.addItem(niveau);
            }
        }
        niveauUpdateCombo.setSelectedItem(allNiveaux.stream()
                .filter(n -> n.getId().equals(etudiant.getNiveauId()))
                .findFirst()
                .orElse(null));
        updatePanel.add(niveauUpdateCombo, gbc);

        gbc.gridx = 0;
        gbc.gridy = 1;
        updatePanel.add(createEnhancedFormLabel("Parcours"), gbc);
        gbc.gridx = 1;
        JComboBox<Parcours> parcoursUpdateCombo = createEnhancedParcoursComboBox();
        parcoursUpdateCombo.setPreferredSize(new Dimension(300, 40));
        for (Parcours parcours : allParcours) {
            if (parcours != null) {
                parcoursUpdateCombo.addItem(parcours);
            }
        }
        parcoursUpdateCombo.setSelectedItem(allParcours.stream()
                .filter(p -> p.getId().equals(etudiant.getParcoursId()))
                .findFirst()
                .orElse(null));
        updatePanel.add(parcoursUpdateCombo, gbc);

        mainPanel.add(updatePanel, BorderLayout.CENTER);

        JPanel buttonPanel = new JPanel(new FlowLayout(FlowLayout.RIGHT));
        buttonPanel.setBackground(CARD_COLOR);
        JButton saveButton = createEnhancedButton("Enregistrer", PRIMARY_COLOR, true);
        saveButton.addActionListener(_ -> {
            Niveau selectedNiveau = (Niveau) niveauUpdateCombo.getSelectedItem();
            Parcours selectedParcours = (Parcours) parcoursUpdateCombo.getSelectedItem();
            if (selectedNiveau != null && selectedParcours != null) {
                try {
                    studentService.updateNiveauParcours(etudiant.getId(), selectedNiveau.getId(), selectedParcours.getId());
                    showSuccessNotification("Niveau et parcours mis √† jour avec succ√®s!");
                    loadStudents();
                    dialog.dispose();
                } catch (ApiException ex) {
                    showErrorNotification("Erreur lors de la mise √† jour: " + ex.getMessage());
                }
            }
        });
        JButton cancelButton = createEnhancedButton("Annuler", ERROR_COLOR, true);
        cancelButton.addActionListener(_ -> dialog.dispose());
        buttonPanel.add(saveButton);
        buttonPanel.add(cancelButton);
        mainPanel.add(buttonPanel, BorderLayout.SOUTH);

        dialog.add(mainPanel);
        dialog.setVisible(true);
    }

    private void showSuccessNotification(String message) {
        JOptionPane.showMessageDialog(this, message, "Succ√®s", JOptionPane.INFORMATION_MESSAGE);
    }

    private void showErrorNotification(String message) {
        JOptionPane.showMessageDialog(this, message, "Erreur", JOptionPane.ERROR_MESSAGE);
    }

    private void showWarningNotification(String message) {
        JOptionPane.showMessageDialog(this, message, "Avertissement", JOptionPane.WARNING_MESSAGE);
    }

    private void showEnhancedErrorDialog(String message) {
        JDialog errorDialog = new JDialog((Frame) SwingUtilities.getWindowAncestor(this), "Erreur", true);
        errorDialog.setLayout(new BorderLayout());
        errorDialog.setSize(400, 200);
        errorDialog.setLocationRelativeTo(this);

        JPanel panel = new JPanel(new BorderLayout());
        panel.setBackground(CARD_COLOR);
        panel.setBorder(BorderFactory.createEmptyBorder(20, 20, 20, 20));

        JLabel label = new JLabel(message);
        label.setFont(getEmojiSupportedFont(Font.PLAIN, 14));
        label.setForeground(TEXT_PRIMARY);
        panel.add(label, BorderLayout.CENTER);

        JButton okButton = createEnhancedButton("OK", PRIMARY_COLOR, true);
        okButton.addActionListener(_ -> errorDialog.dispose());
        JPanel buttonPanel = new JPanel(new FlowLayout(FlowLayout.CENTER));
        buttonPanel.setBackground(CARD_COLOR);
        buttonPanel.add(okButton);
        panel.add(buttonPanel, BorderLayout.SOUTH);

        errorDialog.add(panel);
        errorDialog.setVisible(true);
    }

    private boolean isValidEmail(String email) {
        String emailRegex = "^[A-Za-z0-9+_.-]+@[A-Za-z0-9.-]+$";
        Pattern pattern = Pattern.compile(emailRegex);
        return pattern.matcher(email).matches();
    }

    private void validateEmailField(JTextField emailField) {
        String email = emailField.getText().trim();
        if (!isValidEmail(email) && !email.isEmpty()) {
            emailField.setBorder(BorderFactory.createCompoundBorder(
                    new ModernBorder(ERROR_COLOR),
                    BorderFactory.createEmptyBorder(12, 16, 12, 16)));
        } else {
            emailField.setBorder(BorderFactory.createCompoundBorder(
                    new ModernBorder(BORDER_COLOR),
                    BorderFactory.createEmptyBorder(12, 16, 12, 16)));
        }
    }

    private void clearFields() {
        matriculeField.setText("");
        firstNameField.setText("");
        lastNameField.setText("");
        emailField.setText("");
        adresseField.setText("");
        niveauClasseField.setText("");
        niveauComboBox.setSelectedIndex(-1);
        parcoursComboBox.setSelectedIndex(-1);
        selectedPhoto = null;
        photoPreviewLabel.setText("Aucune photo s√©lectionn√©e");
        photoPreviewLabel.setForeground(TEXT_SECONDARY);
    }

    private class EnhancedPhotoCellRenderer extends JPanel implements TableCellRenderer {
        private EnhancedRoundImageLabel imageLabel;

        public EnhancedPhotoCellRenderer() {
            setLayout(new FlowLayout(FlowLayout.CENTER));
            imageLabel = new EnhancedRoundImageLabel(40);
            add(imageLabel);
            setOpaque(true);
        }

        @Override
        public Component getTableCellRendererComponent(JTable table, Object value, boolean isSelected, boolean hasFocus, int row, int column) {
            setBackground(isSelected ? table.getSelectionBackground() : table.getBackground());
            Etudiant etudiant = (Etudiant) table.getModel().getValueAt(row, 9);
            if (etudiant != null && etudiant.getphoto_url() != null && !etudiant.getphoto_url().isEmpty()) {
                try {
                    imageLabel.setImage(URI.create(etudiant.getphoto_url()).toURL());
                } catch (Exception e) {
                    imageLabel.setText("üë§");
                }
            } else {
                imageLabel.setText("üë§");
            }
            return this;
        }
    }

    private class EnhancedButtonRenderer extends JPanel implements TableCellRenderer {
        private JButton editButton;
        private JButton deleteButton;
        private JButton updateButton;
        private JButton notesButton;

        public EnhancedButtonRenderer() {
            setLayout(new FlowLayout(FlowLayout.CENTER, 8, 8));
            setOpaque(false);

            editButton = createEnhancedTableActionButton("‚úèÔ∏è", WARNING_COLOR);
            deleteButton = createEnhancedTableActionButton("üóëÔ∏è", ERROR_COLOR);
            updateButton = createEnhancedTableActionButton("üîÑ", SECONDARY_COLOR);
            notesButton = createEnhancedTableActionButton("üìù", NOTES_COLOR);

            add(editButton);
            add(deleteButton);
            add(updateButton);
            add(notesButton);
        }

        private JButton createEnhancedTableActionButton(String text, Color color) {
            JButton button = new JButton(text) {
                @Override
                protected void paintComponent(Graphics g) {
                    Graphics2D g2d = (Graphics2D) g.create();
                    g2d.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);
                    g2d.setColor(color);
                    g2d.fillRoundRect(0, 0, getWidth(), getHeight(), 8, 8);
                    g2d.dispose();
                    super.paintComponent(g);
                }
            };

            button.setFont(getEmojiSupportedFont(Font.PLAIN, 13));
            button.setForeground(Color.WHITE);
            button.setContentAreaFilled(false);
            button.setBorderPainted(false);
            button.setFocusPainted(false);
            button.setPreferredSize(new Dimension(35, 30));
            button.setCursor(new Cursor(Cursor.HAND_CURSOR));

            return button;
        }

        @Override
        public Component getTableCellRendererComponent(JTable table, Object value, boolean isSelected, boolean hasFocus, int row, int column) {
            setBackground(isSelected ? table.getSelectionBackground() : table.getBackground());
            return this;
        }
    }

    private class EnhancedButtonEditor extends AbstractCellEditor implements TableCellEditor {
        private JPanel panel;
        private JButton editButton;
        private JButton deleteButton;
        private JButton updateButton;
        private JButton notesButton;
        private Etudiant currentStudent;

        public EnhancedButtonEditor() {
            panel = new JPanel(new FlowLayout(FlowLayout.CENTER, 8, 8));
            panel.setOpaque(false);

            editButton = createEnhancedTableActionButton("‚úèÔ∏è", WARNING_COLOR);
            deleteButton = createEnhancedTableActionButton("üóëÔ∏è", ERROR_COLOR);
            updateButton = createEnhancedTableActionButton("üîÑ", SECONDARY_COLOR);
            notesButton = createEnhancedTableActionButton("üìù", NOTES_COLOR);

            editButton.addActionListener(_ -> {
                fireEditingStopped();
                if (currentStudent != null) {
                    showStudentFormDialog(currentStudent);
                }
            });

            deleteButton.addActionListener(_ -> {
                fireEditingStopped();
                if (currentStudent != null && currentStudent.getId() != null) {
                    deleteStudent(currentStudent.getId());
                }
            });

            updateButton.addActionListener(_ -> {
                fireEditingStopped();
                if (currentStudent != null) {
                    showUpdateNiveauParcoursDialog(currentStudent);
                }
            });

            notesButton.addActionListener(_ -> {
                fireEditingStopped();
                if (currentStudent != null) {
                    showNotesDialog(currentStudent);
                }
            });

            panel.add(editButton);
            panel.add(deleteButton);
            panel.add(updateButton);
            panel.add(notesButton);
        }

        private JButton createEnhancedTableActionButton(String text, Color color) {
            JButton button = new JButton(text) {
                @Override
                protected void paintComponent(Graphics g) {
                    Graphics2D g2d = (Graphics2D) g.create();
                    g2d.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);
                    g2d.setColor(color);
                    g2d.fillRoundRect(0, 0, getWidth(), getHeight(), 8, 8);
                    g2d.dispose();
                    super.paintComponent(g);
                }
            };

            button.setFont(getEmojiSupportedFont(Font.PLAIN, 13));
            button.setForeground(Color.WHITE);
            button.setContentAreaFilled(false);
            button.setBorderPainted(false);
            button.setFocusPainted(false);
            button.setPreferredSize(new Dimension(35, 30));
            button.setCursor(new Cursor(Cursor.HAND_CURSOR));

            return button;
        }

        @Override
        public Component getTableCellEditorComponent(JTable table, Object value, boolean isSelected, int row, int column) {
            currentStudent = (Etudiant) table.getModel().getValueAt(row, 9);
            return panel;
        }

        @Override
        public Object getCellEditorValue() {
            return "Actions";
        }
    }

    private class NotesButtonRenderer extends JPanel implements TableCellRenderer {
        private JButton editButton;

        public NotesButtonRenderer() {
            setLayout(new FlowLayout(FlowLayout.CENTER));
            setOpaque(false);

            editButton = createEnhancedTableActionButton("‚úèÔ∏è", WARNING_COLOR);
            add(editButton);
        }

        private JButton createEnhancedTableActionButton(String text, Color color) {
            JButton button = new JButton(text) {
                @Override
                protected void paintComponent(Graphics g) {
                    Graphics2D g2d = (Graphics2D) g.create();
                    g2d.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);
                    g2d.setColor(color);
                    g2d.fillRoundRect(0, 0, getWidth(), getHeight(), 8, 8);
                    g2d.dispose();
                    super.paintComponent(g);
                }
            };

            button.setFont(getEmojiSupportedFont(Font.PLAIN, 13));
            button.setForeground(Color.WHITE);
            button.setContentAreaFilled(false);
            button.setBorderPainted(false);
            button.setFocusPainted(false);
            button.setPreferredSize(new Dimension(35, 30));
            button.setCursor(new Cursor(Cursor.HAND_CURSOR));

            return button;
        }

        @Override
        public Component getTableCellRendererComponent(JTable table, Object value, boolean isSelected, boolean hasFocus, int row, int column) {
            setBackground(isSelected ? table.getSelectionBackground() : table.getBackground());
            return this;
        }
    }

    private class NotesButtonEditor extends AbstractCellEditor implements TableCellEditor {
        private JPanel panel;
        private JButton editButton;
        private Etudiant etudiant;
        private JTable notesTable;
        private DefaultTableModel tableModel;

        public NotesButtonEditor(Etudiant etudiant, JTable notesTable, DefaultTableModel tableModel) {
            this.etudiant = etudiant;
            this.notesTable = notesTable;
            this.tableModel = tableModel;

            panel = new JPanel(new FlowLayout(FlowLayout.CENTER));
            panel.setOpaque(false);

            editButton = createEnhancedTableActionButton("‚úèÔ∏è", WARNING_COLOR);
            editButton.addActionListener(_ -> {
                fireEditingStopped();
                editNote();
            });

            panel.add(editButton);
        }

        private JButton createEnhancedTableActionButton(String text, Color color) {
            JButton button = new JButton(text) {
                @Override
                protected void paintComponent(Graphics g) {
                    Graphics2D g2d = (Graphics2D) g.create();
                    g2d.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);
                    g2d.setColor(color);
                    g2d.fillRoundRect(0, 0, getWidth(), getHeight(), 8, 8);
                    g2d.dispose();
                    super.paintComponent(g);
                }
            };

            button.setFont(getEmojiSupportedFont(Font.PLAIN, 13));
            button.setForeground(Color.WHITE);
            button.setContentAreaFilled(false);
            button.setBorderPainted(false);
            button.setFocusPainted(false);
            button.setPreferredSize(new Dimension(35, 30));
            button.setCursor(new Cursor(Cursor.HAND_CURSOR));

            return button;
        }

        @Override
        public Component getTableCellEditorComponent(JTable table, Object value, boolean isSelected, int row, int column) {
            return panel;
        }

        @Override
        public Object getCellEditorValue() {
            return "Actions";
        }

        private void editNote() {
            int selectedRow = notesTable.getSelectedRow();
            if (selectedRow >= 0) {
                String matiereName = (String) tableModel.getValueAt(selectedRow, 0);
                String currentNote = (String) tableModel.getValueAt(selectedRow, 1);
                String currentSemestre = (String) tableModel.getValueAt(selectedRow, 2);
                String currentAnnee = (String) tableModel.getValueAt(selectedRow, 3);

                JTextField noteField = new JTextField(currentNote, 10);
                JTextField semestreField = new JTextField(currentSemestre, 10);
                JTextField anneeField = new JTextField(currentAnnee, 10);

                JPanel inputPanel = new JPanel(new GridBagLayout());
                GridBagConstraints gbc = new GridBagConstraints();
                gbc.insets = new Insets(5, 5, 5, 5);
                gbc.fill = GridBagConstraints.HORIZONTAL;

                gbc.gridx = 0;
                gbc.gridy = 0;
                inputPanel.add(new JLabel("Note pour " + matiereName + ":"), gbc);
                gbc.gridx = 1;
                inputPanel.add(noteField, gbc);

                gbc.gridx = 0;
                gbc.gridy = 1;
                inputPanel.add(new JLabel("Semestre:"), gbc);
                gbc.gridx = 1;
                inputPanel.add(semestreField, gbc);

                gbc.gridx = 0;
                gbc.gridy = 2;
                inputPanel.add(new JLabel("Ann√©e:"), gbc);
                gbc.gridx = 1;
                inputPanel.add(anneeField, gbc);

                int result = JOptionPane.showConfirmDialog(null, inputPanel, "Modifier la Note", JOptionPane.OK_CANCEL_OPTION);
                if (result == JOptionPane.OK_OPTION) {
                    try {
                        double noteValue = Double.parseDouble(noteField.getText().trim());
                        if (noteValue < 0 || noteValue > 20) {
                            showErrorNotification("La note doit √™tre comprise entre 0 et 20.");
                            return;
                        }

                        String semestre = semestreField.getText().trim();
                        String annee = anneeField.getText().trim();
                        if (semestre.isEmpty() || annee.isEmpty()) {
                            showErrorNotification("Les champs Semestre et Ann√©e sont obligatoires.");
                            return;
                        }

                        Matiere matiere = studentService.getAllMatieres().stream()
                                .filter(m -> m.getNom().equals(matiereName))
                                .findFirst()
                                .orElse(null);
                        if (matiere != null) {
                            Note note = new Note();
                            note.setEtudiantId(etudiant.getId());
                            note.setMatiereId(matiere.getId());
                            note.setValeur((float) noteValue);
                            note.setSemestre(semestre);
                            note.setAnnee(annee);

                            List<Note> existingNotes = studentService.getNotesByEtudiant(etudiant.getId());
                            Note existingNote = existingNotes.stream()
                                    .filter(n -> n.getMatiereId().equals(matiere.getId()) &&
                                            n.getSemestre().equals(semestre) &&
                                            n.getAnnee().equals(annee))
                                    .findFirst()
                                    .orElse(null);

                            if (existingNote != null) {
                                note.setId(existingNote.getId());
                                studentService.updateNote(existingNote.getId(), note);
                            } else {
                                studentService.addNote(note);
                            }
                            tableModel.setValueAt(String.valueOf(noteValue), selectedRow, 1);
                            tableModel.setValueAt(semestre, selectedRow, 2);
                            tableModel.setValueAt(annee, selectedRow, 3);
                            showSuccessNotification("Note mise √† jour avec succ√®s!");
                        }
                    } catch (NumberFormatException ex) {
                        showErrorNotification("Veuillez entrer une note valide.");
                    } catch (ApiException ex) {
                        showErrorNotification("Erreur lors de la mise √† jour de la note: " + ex.getMessage());
                    }
                }
            }
        }
    }

    private class ModernBorder extends AbstractBorder {
        private final Color borderColor;

        public ModernBorder(Color borderColor) {
            this.borderColor = borderColor;
        }

        @Override
        public void paintBorder(Component c, Graphics g, int x, int y, int width, int height) {
            Graphics2D g2d = (Graphics2D) g.create();
            g2d.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);
            g2d.setColor(borderColor);
            g2d.setStroke(new BasicStroke(1));
            g2d.drawRoundRect(x, y, width - 1, height - 1, 12, 12);
            g2d.dispose();
        }

        @Override
        public Insets getBorderInsets(Component c) {
            return new Insets(4, 4, 4, 4);
        }

        @Override
        public boolean isBorderOpaque() {
            return true;
        }
    }

    private class EnhancedRoundImageLabel extends JLabel {
        private Image image;
        private int size;

        public EnhancedRoundImageLabel(int size) {
            this.size = size;
            setPreferredSize(new Dimension(size, size));
            setHorizontalAlignment(CENTER);
            setVerticalAlignment(CENTER);
            setFont(getEmojiSupportedFont(Font.PLAIN, size / 2));
        }

        public void setImage(URL url) {
            try {
                image = new ImageIcon(url).getImage();
                setText(null);
                repaint();
            } catch (Exception e) {
                image = null;
                setText("üë§");
            }
        }

        @Override
        protected void paintComponent(Graphics g) {
            Graphics2D g2d = (Graphics2D) g.create();
            g2d.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);

            Shape clip = new Ellipse2D.Double(0, 0, size, size);
            g2d.setClip(clip);

            if (image != null) {
                g2d.drawImage(image, 0, 0, size, size, this);
            } else {
                super.paintComponent(g2d);
            }

            g2d.setClip(null);
            g2d.setColor(BORDER_COLOR);
            g2d.setStroke(new BasicStroke(2));
            g2d.drawOval(0, 0, size - 1, size - 1);

            g2d.dispose();
        }
    }
}